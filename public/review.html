<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Attempt Logs</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 1100px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    th, td { padding: 0.6rem 0.5rem; border: 1px solid #ddd; text-align: left; }
    th { background: #007bff; color: #fff; cursor: pointer; }
    tr.suspicious { background: #fff3cd; }
    tr.blocked { background: #f8d7da; }
    tr.success { background: #d4edda; }
    tr:hover { background: #f1f1f1; }
    .filter-bar { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; }
    .filter-bar label { font-weight: bold; }
    .back-link { display: inline-block; margin-bottom: 1rem; color: #007bff; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; Back to Login</a>
    <h2>Login Attempt Logs</h2>
    <div class="filter-bar">
      <label for="riskFilter">Risk:</label>
      <select id="riskFilter">
        <option value="all">All</option>
        <option value="high">High (&ge;10)</option>
        <option value="medium">Medium (5-9)</option>
        <option value="low">Low (&lt;5)</option>
      </select>
      <label for="successFilter">Result:</label>
      <select id="successFilter">
        <option value="all">All</option>
        <option value="success">Success</option>
        <option value="fail">Fail</option>
      </select>
      <label for="countryFilter">Country:</label>
      <input type="text" id="countryFilter" placeholder="e.g. India">
      <button onclick="applyFilters()">Apply Filters</button>
      <button onclick="resetFilters()">Reset</button>
    </div>
    <table id="logsTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Time</th>
          <th onclick="sortTable(1)">Username</th>
          <th onclick="sortTable(2)">IP</th>
          <th onclick="sortTable(3)">Browser</th>
          <th onclick="sortTable(4)">Country</th>
          <th onclick="sortTable(5)">City</th>
          <th onclick="sortTable(6)">Success</th>
          <th onclick="sortTable(7)">Reason</th>
          <th onclick="sortTable(8)">Risk</th>
        </tr>
      </thead>
      <tbody id="logsBody"></tbody>
    </table>
  </div>
  <script>
    let logs = [];
    let sortDir = 1;
    let lastSortCol = 0;

    async function fetchLogs() {
      const res = await fetch('/logs');
      logs = await res.json();
      renderTable(logs);
    }

    function renderTable(data) {
      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = '';
      data.forEach(log => {
        let rowClass = '';
        if (log.risk >= 10) rowClass = 'blocked';
        else if (log.risk >= 5) rowClass = 'suspicious';
        else if (log.success) rowClass = 'success';
        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.username}</td>
          <td>${log.ip}</td>
          <td>${log.browser}</td>
          <td>${log.geo?.country || ''}</td>
          <td>${log.geo?.city || ''}</td>
          <td>${log.success ? '✔️' : '❌'}</td>
          <td>${log.reason}</td>
          <td>${log.risk}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function sortTable(col) {
      if (lastSortCol === col) sortDir *= -1;
      else sortDir = 1;
      lastSortCol = col;
      logs.sort((a, b) => {
        let valA, valB;
        switch(col) {
          case 0: valA = new Date(a.timestamp); valB = new Date(b.timestamp); break;
          case 1: valA = a.username; valB = b.username; break;
          case 2: valA = a.ip; valB = b.ip; break;
          case 3: valA = a.browser; valB = b.browser; break;
          case 4: valA = a.geo?.country || ''; valB = b.geo?.country || ''; break;
          case 5: valA = a.geo?.city || ''; valB = b.geo?.city || ''; break;
          case 6: valA = a.success; valB = b.success; break;
          case 7: valA = a.reason; valB = b.reason; break;
          case 8: valA = a.risk; valB = b.risk; break;
        }
        if (valA < valB) return -1 * sortDir;
        if (valA > valB) return 1 * sortDir;
        return 0;
      });
      renderTable(logs);
    }

    function applyFilters() {
      const risk = document.getElementById('riskFilter').value;
      const success = document.getElementById('successFilter').value;
      const country = document.getElementById('countryFilter').value.trim().toLowerCase();
      let filtered = logs;
      if (risk !== 'all') {
        filtered = filtered.filter(log =>
          (risk === 'high' && log.risk >= 10) ||
          (risk === 'medium' && log.risk >= 5 && log.risk < 10) ||
          (risk === 'low' && log.risk < 5)
        );
      }
      if (success !== 'all') {
        filtered = filtered.filter(log =>
          (success === 'success' && log.success) ||
          (success === 'fail' && !log.success)
        );
      }
      if (country) {
        filtered = filtered.filter(log => (log.geo?.country || '').toLowerCase().includes(country));
      }
      renderTable(filtered);
    }

    function resetFilters() {
      document.getElementById('riskFilter').value = 'all';
      document.getElementById('successFilter').value = 'all';
      document.getElementById('countryFilter').value = '';
      renderTable(logs);
    }

    window.onload = fetchLogs;
  </script>
</body>
</html> 